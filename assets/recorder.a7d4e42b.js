import{_ as b,d as x,g as d,a2 as F,R as S,o as y,c as m,b as p,t as M,i as w,x as _,e as D}from"./app.c90e916d.js";const B=class{constructor(e){this.isDebugger=!1,this.mediaRecorder="",this.mediaStreamSource=null,this.audioCtx=null,this.analyser=null,this.stopDraw=!0;const{barWidth:t=3,baseLine:s=3,canvas:o="",color:a="#fff",space:n=3,type:r="audio/mp3",option:i={},onstop:u={},onstart:l={},onerror:c={},isDebugger:h=!1}=e;this.barWidth=t,this.baseLine=s,this.canvas=o,this.color=a,this.space=n,this.type=r,this.option=i,this.onstop=u,this.onstart=l,this.onerror=c,this.isDebugger=h}log(...e){this.isDebugger&&console.log(...e)}visualize(e){this.audioCtx.createMediaStreamSource(e).connect(this.analyser),this.analyser.fftSize=256,this.analyser.connect(this.audioCtx.destination);const s=document.querySelector(this.canvas),{clientWidth:o,clientHeight:a}=s;s.width=o,s.height=a;const n=Math.floor(o/(this.barWidth+this.space)),r=s.getContext("2d"),i=()=>{if(r.clearRect(0,0,o,a),this.stopDraw)return;const u=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(u);let l=0;r.fillStyle=this.color;for(let c=0;c<n;c++){const h=u[c]/256*a||this.baseLine,f=a/2-h/2;r.fillRect(l,f,this.barWidth,h),l+=this.barWidth+this.space}window.requestAnimationFrame(i)};i()}initMediaDevices(){return!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia&&!!window.MediaRecorder}initRecording(){navigator.mediaDevices.getUserMedia(this.option).then(e=>{const t=[];if(this.mediaRecorder=new MediaRecorder(e),this.canvas){this.stopDraw=!1;try{this.audioCtx=new window.AudioContext,this.analyser=this.audioCtx.createAnalyser(),this.visualize(e)}catch(s){this.onerror(s),this.closeMediaDevices(e)}}this.mediaRecorder.onstop=()=>{this.closeMediaDevices(e);const s=new Blob(t,{type:this.type});this.readerFile(s).then(o=>{this.onstop(o)})},this.mediaRecorder.ondataavailable=s=>{t.push(s.data)},this.mediaRecorder.onerror=()=>{this.onerror()},this.start(),this.onstart()}).catch(e=>{this.log(e,e.name,e.message),this.onerror()})}closeMediaDevices(e){e&&e.getTracks().forEach(t=>{t&&t.stop()})}readerFile(e){const t=new FileReader;return new Promise((s,o)=>{t.onload=a=>{this.log("\u97F3\u9891\u89E3\u6790\u5B8C\u6210"),s(a.target.result)},t.onerror=a=>{o(a)},t.readAsDataURL(e)})}stop(){this.mediaRecorder&&this.mediaRecorder.stop(),this.stopDraw=!0}start(){this.mediaRecorder&&this.mediaRecorder.start()}};const A={key:0,class:"utry-recorder-container"},k={class:"utry-recorder-container-time"},I={key:0,id:"canvas",width:"120",height:"40"},W={class:"utry-recorder-container-btn"},E=D("\u53D6\u6D88"),q=D("\u53D1\u9001"),L=x({__name:"recorder",props:{show:{type:Boolean},showCanvas:{type:Boolean}},emits:["src","update:show"],setup(e,{emit:t}){const s=e,o=60,a=d(null),n=d(""),r=d(0),i=d(null),u=d(!1),l=d(!1),c=d(!1);F(()=>{a.value=new B({option:{audio:!0},canvas:s.showCanvas?"canvas":"",onstop:v=>{if(!l.value&&(n.value=v,!u.value)){const g=o-r.value;t("src",n.value,g),t("update:show",!1)}},onstart:()=>f(),onerror:()=>{alert("\u6D4F\u89C8\u5668\u4E0D\u652F\u6301"),t("update:show",!1)}}),c.value=a.value.initMediaDevices(),c.value||(alert("\u6D4F\u89C8\u5668\u4E0D\u652F\u6301"),t("update:show",!1))}),S(()=>{c.value&&h()});function h(){clearInterval(i.value),r.value=o,n.value="",l.value=!1,u.value=!1,a.value.initRecording()}function f(){i.value=setInterval(()=>{r.value<=0?(u.value=!0,a.value.stop(),clearInterval(i.value)):r.value--},1e3)}function R(){if(clearInterval(i.value),n.value){const v=o-r.value;t("src",n.value,v),t("update:show",!1)}else a.value.stop()}function C(){i.value&&clearInterval(i.value),l.value=!0,!n.value&&a.value.stop(),t("update:show",!1)}return(v,g)=>c.value?(y(),m("div",A,[p("span",k,M(r.value?`\u6B63\u5728\u5F55\u97F3${r.value}s`:"\u5F55\u97F3\u5B8C\u6210"),1),e.showCanvas?(y(),m("canvas",I)):w("",!0),p("div",W,[p("span",{onClick:C},[_(v.$slots,"cancel",{},()=>[E],!0)]),p("span",{onClick:R},[_(v.$slots,"send",{},()=>[q],!0)])])])):w("",!0)}});var U=b(L,[["__scopeId","data-v-704f5054"],["__file","recorder.vue"]]);export{U as default};
