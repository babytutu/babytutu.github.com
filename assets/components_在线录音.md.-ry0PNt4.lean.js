import{d as g,h as i,a5 as q,l as R,o as h,c as b,m as y,t as x,e as A,r as f,a as D,_ as S,J as k,w as F,a4 as E,E as M,b as P}from"./chunks/framework.Dh_iM4ES.js";const N=class{constructor(s){this.isDebugger=!1,this.mediaRecorder="",this.mediaStreamSource=null,this.audioCtx=null,this.analyser=null,this.stopDraw=!0;const{barWidth:n=3,baseLine:a=3,canvas:e="",color:l="#fff",space:o=3,type:t="audio/mp3",option:p={},onstop:r={},onstart:B={},onerror:c={},isDebugger:u=!1}=s;this.barWidth=n,this.baseLine=a,this.canvas=e,this.color=l,this.space=o,this.type=t,this.option=p,this.onstop=r,this.onstart=B,this.onerror=c,this.isDebugger=u}log(...s){this.isDebugger&&console.log(...s)}visualize(s){this.audioCtx.createMediaStreamSource(s).connect(this.analyser),this.analyser.fftSize=256,this.analyser.connect(this.audioCtx.destination);const a=document.querySelector(this.canvas),{clientWidth:e,clientHeight:l}=a;a.width=e,a.height=l;const o=Math.floor(e/(this.barWidth+this.space)),t=a.getContext("2d"),p=()=>{if(t.clearRect(0,0,e,l),this.stopDraw)return;const r=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(r);let B=0;t.fillStyle=this.color;for(let c=0;c<o;c++){const u=r[c]/256*l||this.baseLine,m=l/2-u/2;t.fillRect(B,m,this.barWidth,u),B+=this.barWidth+this.space}window.requestAnimationFrame(p)};p()}initMediaDevices(){return!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia&&!!window.MediaRecorder}initRecording(){navigator.mediaDevices.getUserMedia(this.option).then(s=>{const n=[];if(this.mediaRecorder=new MediaRecorder(s),this.canvas){this.stopDraw=!1;try{this.audioCtx=new window.AudioContext,this.analyser=this.audioCtx.createAnalyser(),this.visualize(s)}catch(a){this.onerror(a),this.closeMediaDevices(s)}}this.mediaRecorder.onstop=()=>{this.closeMediaDevices(s);const a=new Blob(n,{type:this.type});this.readerFile(a).then(e=>{this.onstop(e)})},this.mediaRecorder.ondataavailable=a=>{n.push(a.data)},this.mediaRecorder.onerror=()=>{this.onerror()},this.start(),this.onstart()}).catch(s=>{this.log(s,s.name,s.message),this.onerror()})}closeMediaDevices(s){s&&s.getTracks().forEach(n=>{n&&n.stop()})}readerFile(s){const n=new FileReader;return new Promise((a,e)=>{n.onload=l=>{this.log("音频解析完成"),a(l.target.result)},n.onerror=l=>{e(l)},n.readAsDataURL(s)})}stop(){this.mediaRecorder&&this.mediaRecorder.stop(),this.stopDraw=!0}start(){this.mediaRecorder&&this.mediaRecorder.start()}},I={key:0,class:"utry-recorder-container"},W={class:"utry-recorder-container-time"},U={key:0,id:"canvas",width:"120",height:"40"},V={class:"utry-recorder-container-btn"},v=60,$=g({__name:"recorder",props:{show:{type:Boolean},showCanvas:{type:Boolean}},emits:["src","update:show"],setup(s,{emit:n}){const a=s,e=n,l=i(null),o=i(""),t=i(0),p=i(null),r=i(!1),B=i(!1),c=i(!1);q(()=>{l.value=new N({option:{audio:!0},canvas:a.showCanvas?"canvas":"",onstop:d=>{if(!B.value&&(o.value=d,!r.value)){const C=v-t.value;e("src",o.value,C),e("update:show",!1)}},onstart:()=>m(),onerror:()=>{alert("浏览器不支持"),e("update:show",!1)}}),c.value=l.value.initMediaDevices(),c.value||(alert("浏览器不支持"),e("update:show",!1))}),R(()=>{c.value&&u()});function u(){clearInterval(p.value),t.value=v,o.value="",B.value=!1,r.value=!1,l.value.initRecording()}function m(){p.value=setInterval(()=>{t.value<=0?(r.value=!0,l.value.stop(),clearInterval(p.value)):t.value--},1e3)}function w(){if(clearInterval(p.value),o.value){const d=v-t.value;e("src",o.value,d),e("update:show",!1)}else l.value.stop()}function _(){p.value&&clearInterval(p.value),B.value=!0,!o.value&&l.value.stop(),e("update:show",!1)}return(d,C)=>c.value?(h(),b("div",I,[y("span",W,x(t.value?`正在录音${t.value}s`:"录音完成"),1),d.showCanvas?(h(),b("canvas",U)):A("",!0),y("div",V,[y("span",{onClick:_},[f(d.$slots,"cancel",{},()=>[D("取消")],!0)]),y("span",{onClick:w},[f(d.$slots,"send",{},()=>[D("发送")],!0)])])])):A("",!0)}}),L=S($,[["__scopeId","data-v-dc7a5bc7"]]),z=E('<h1 id="在线录音" tabindex="-1">在线录音 <a class="header-anchor" href="#在线录音" aria-label="Permalink to &quot;在线录音&quot;">​</a></h1><p>使用<code>mediarecorder</code>实现纯前端在线录音，仅支持<code>localhost</code>和<code>https</code>环境，需要开启浏览器<code>麦克风权限</code>。</p><h2 id="demo" tabindex="-1">Demo <a class="header-anchor" href="#demo" aria-label="Permalink to &quot;Demo&quot;">​</a></h2><p>点击[完成]，将base64数据进行预览播放</p>',4),O=["disabled"],H={class:"recorder-container"},J=y("button",{class:"btn"},"发送",-1),T=y("button",{class:"btn"},"取消",-1),j=["src"],G=E(`<div class="language-vue line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki one-dark-pro vp-code"><code><span class="line"><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">template</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">  &lt;</span><span style="color:#E06C75;">button</span><span style="color:#D19A66;"> class</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">&quot;btn&quot;</span><span style="color:#ABB2BF;"> @</span><span style="color:#D19A66;">click</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">startRecoreder</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#ABB2BF;"> :</span><span style="color:#D19A66;">disabled</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">showRecorder</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#ABB2BF;">&gt;开始录音&lt;/</span><span style="color:#E06C75;">button</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">  &lt;</span><span style="color:#E06C75;">div</span><span style="color:#D19A66;"> class</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">&quot;recorder-container&quot;</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    &lt;</span><span style="color:#E06C75;">recorder</span><span style="color:#D19A66;"> v-model</span><span style="color:#ABB2BF;">:</span><span style="color:#D19A66;">show</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">showRecorder</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#C678DD;"> v-if</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">showRecorder</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#ABB2BF;"> @</span><span style="color:#D19A66;">src</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">getRecord</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#D19A66;"> showCanvas</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">      &lt;</span><span style="color:#E06C75;">template</span><span style="color:#ABB2BF;"> #</span><span style="color:#D19A66;">send</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">        &lt;</span><span style="color:#E06C75;">button</span><span style="color:#D19A66;"> class</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">&quot;btn&quot;</span><span style="color:#ABB2BF;">&gt;发送&lt;/</span><span style="color:#E06C75;">button</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">      &lt;/</span><span style="color:#E06C75;">template</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">      &lt;</span><span style="color:#E06C75;">template</span><span style="color:#ABB2BF;"> #</span><span style="color:#D19A66;">cancel</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">        &lt;</span><span style="color:#E06C75;">button</span><span style="color:#D19A66;"> class</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">&quot;btn&quot;</span><span style="color:#ABB2BF;">&gt;取消&lt;/</span><span style="color:#E06C75;">button</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">      &lt;/</span><span style="color:#E06C75;">template</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    &lt;/</span><span style="color:#E06C75;">recorder</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    &lt;</span><span style="color:#E06C75;">audio</span><span style="color:#ABB2BF;"> :</span><span style="color:#D19A66;">src</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#D19A66;"> controls</span><span style="color:#C678DD;"> v-if</span><span style="color:#ABB2BF;">=</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#E06C75;">src</span><span style="color:#ABB2BF;">&quot;</span><span style="color:#ABB2BF;">&gt;&lt;/</span><span style="color:#E06C75;">audio</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">  &lt;/</span><span style="color:#E06C75;">div</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">&lt;/</span><span style="color:#E06C75;">template</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">script</span><span style="color:#D19A66;"> setup</span><span style="color:#D19A66;"> lang</span><span style="color:#ABB2BF;">=</span><span style="color:#98C379;">&quot;ts&quot;</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> { </span><span style="color:#E06C75;">ref</span><span style="color:#ABB2BF;"> } </span><span style="color:#C678DD;">from</span><span style="color:#98C379;"> &#39;vue&#39;</span></span>
<span class="line"><span style="color:#C678DD;">import</span><span style="color:#E06C75;"> recorder</span><span style="color:#C678DD;"> from</span><span style="color:#98C379;"> &#39;./recorder/recorder.vue&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> showRecorder</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> ref</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">) </span><span style="color:#7F848E;font-style:italic;">// 录音</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#E5C07B;"> src</span><span style="color:#56B6C2;"> =</span><span style="color:#61AFEF;"> ref</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">&gt;(</span><span style="color:#D19A66;">null</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> startRecoreder</span><span style="color:#ABB2BF;"> () {</span></span>
<span class="line"><span style="color:#E5C07B;">  showRecorder</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">value</span><span style="color:#56B6C2;"> =</span><span style="color:#D19A66;"> true</span></span>
<span class="line"><span style="color:#E5C07B;">  src</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">value</span><span style="color:#56B6C2;"> =</span><span style="color:#98C379;"> &#39;&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"> * 获取录音数据</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"> * </span><span style="color:#C678DD;font-style:italic;">@param</span><span style="color:#E5C07B;font-style:italic;"> {string}</span><span style="color:#E06C75;font-style:italic;"> base64</span><span style="color:#7F848E;font-style:italic;"> 录音base64</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C678DD;">function</span><span style="color:#61AFEF;"> getRecord</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">base64</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;">  src</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">value</span><span style="color:#56B6C2;"> =</span><span style="color:#E06C75;"> base64</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">&lt;/</span><span style="color:#E06C75;">script</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">&lt;</span><span style="color:#E06C75;">style</span><span style="color:#D19A66;"> scoped</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#D19A66;">.recorder-container</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  width: </span><span style="color:#D19A66;">100</span><span style="color:#E06C75;">%</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  height: </span><span style="color:#D19A66;">54</span><span style="color:#E06C75;">px</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">&lt;/</span><span style="color:#E06C75;">style</span><span style="color:#ABB2BF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="props" tabindex="-1">Props <a class="header-anchor" href="#props" aria-label="Permalink to &quot;Props&quot;">​</a></h2><table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>v-model:show</td><td>Boolean</td><td>是否显示录音界面，默认false</td></tr><tr><td>showCanvas</td><td>Boolean</td><td>是否显示波形图，非必须｜</td></tr></tbody></table><h2 id="events" tabindex="-1">Events <a class="header-anchor" href="#events" aria-label="Permalink to &quot;Events&quot;">​</a></h2><table><thead><tr><th>名称</th><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>src</td><td>src</td><td>录音base64</td></tr></tbody></table><h2 id="slots" tabindex="-1">Slots <a class="header-anchor" href="#slots" aria-label="Permalink to &quot;Slots&quot;">​</a></h2><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>cancel</td><td>取消按钮</td></tr><tr><td>send</td><td>完成按钮</td></tr></tbody></table>`,7),X=JSON.parse('{"title":"在线录音","description":"","frontmatter":{},"headers":[],"relativePath":"components/在线录音.md","filePath":"components/在线录音.md"}'),K={name:"components/在线录音.md"},Y=g({...K,setup(s){const n=i(!1),a=i(null);function e(){n.value=!0,a.value=""}function l(o){a.value=o}return(o,t)=>{const p=M("ClientOnly");return h(),b("div",null,[z,k(p,null,{default:F(()=>[y("button",{class:"btn",onClick:e,disabled:n.value},"开始录音",8,O),y("div",H,[n.value?(h(),P(L,{key:0,show:n.value,"onUpdate:show":t[0]||(t[0]=r=>n.value=r),onSrc:l,showCanvas:""},{send:F(()=>[J]),cancel:F(()=>[T]),_:1},8,["show"])):A("",!0),a.value?(h(),b("audio",{key:1,src:a.value,controls:""},null,8,j)):A("",!0)])]),_:1}),G])}}});export{X as __pageData,Y as default};
